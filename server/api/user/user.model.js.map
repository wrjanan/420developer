{"version":3,"sources":["../../../../server/api/user/user.model.js"],"names":[],"mappings":"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","file":"user.model.js","sourcesContent":["'use strict';\n\nimport crypto from 'crypto';\nimport mongoose from 'mongoose';\nmongoose.Promise = require('bluebird');\nimport {Schema} from 'mongoose';\n\nconst authTypes = ['github', 'twitter', 'facebook', 'google'];\n\nvar UserSchema = new Schema({\n  name: String,\n  email: {\n    type: String,\n    lowercase: true\n  },\n  role: {\n    type: String,\n    default: 'user'\n  },\n  password: String,\n  provider: String,\n  salt: String,\n  facebook: {},\n  github: {}\n});\n\n/**\n * Virtuals\n */\n\n// Public profile information\nUserSchema\n  .virtual('profile')\n  .get(function() {\n    return {\n      'name': this.name,\n      'role': this.role\n    };\n  });\n\n// Non-sensitive info we'll be putting in the token\nUserSchema\n  .virtual('token')\n  .get(function() {\n    return {\n      '_id': this._id,\n      'role': this.role\n    };\n  });\n\n/**\n * Validations\n */\n\n// Validate empty email\nUserSchema\n  .path('email')\n  .validate(function(email) {\n    if (authTypes.indexOf(this.provider) !== -1) {\n      return true;\n    }\n    return email.length;\n  }, 'Email cannot be blank');\n\n// Validate empty password\nUserSchema\n  .path('password')\n  .validate(function(password) {\n    if (authTypes.indexOf(this.provider) !== -1) {\n      return true;\n    }\n    return password.length;\n  }, 'Password cannot be blank');\n\n// Validate email is not taken\nUserSchema\n  .path('email')\n  .validate(function(value, respond) {\n    var self = this;\n    return this.constructor.findOne({ email: value }).exec()\n      .then(function(user) {\n        if (user) {\n          if (self.id === user.id) {\n            return respond(true);\n          }\n          return respond(false);\n        }\n        return respond(true);\n      })\n      .catch(function(err) {\n        throw err;\n      });\n  }, 'The specified email address is already in use.');\n\nvar validatePresenceOf = function(value) {\n  return value && value.length;\n};\n\n/**\n * Pre-save hook\n */\nUserSchema\n  .pre('save', function(next) {\n    // Handle new/update passwords\n    if (!this.isModified('password')) {\n      return next();\n    }\n\n    if (!validatePresenceOf(this.password) && authTypes.indexOf(this.provider) === -1) {\n      return next(new Error('Invalid password'));\n    }\n\n    // Make salt with a callback\n    this.makeSalt((saltErr, salt) => {\n      if (saltErr) {\n        return next(saltErr);\n      }\n      this.salt = salt;\n      this.encryptPassword(this.password, (encryptErr, hashedPassword) => {\n        if (encryptErr) {\n          return next(encryptErr);\n        }\n        this.password = hashedPassword;\n        next();\n      });\n    });\n  });\n\n/**\n * Methods\n */\nUserSchema.methods = {\n  /**\n   * Authenticate - check if the passwords are the same\n   *\n   * @param {String} password\n   * @param {Function} callback\n   * @return {Boolean}\n   * @api public\n   */\n  authenticate(password, callback) {\n    if (!callback) {\n      return this.password === this.encryptPassword(password);\n    }\n\n    this.encryptPassword(password, (err, pwdGen) => {\n      if (err) {\n        return callback(err);\n      }\n\n      if (this.password === pwdGen) {\n        callback(null, true);\n      } else {\n        callback(null, false);\n      }\n    });\n  },\n\n  /**\n   * Make salt\n   *\n   * @param {Number} byteSize Optional salt byte size, default to 16\n   * @param {Function} callback\n   * @return {String}\n   * @api public\n   */\n  makeSalt(byteSize, callback) {\n    var defaultByteSize = 16;\n\n    if (typeof arguments[0] === 'function') {\n      callback = arguments[0];\n      byteSize = defaultByteSize;\n    } else if (typeof arguments[1] === 'function') {\n      callback = arguments[1];\n    }\n\n    if (!byteSize) {\n      byteSize = defaultByteSize;\n    }\n\n    if (!callback) {\n      return crypto.randomBytes(byteSize).toString('base64');\n    }\n\n    return crypto.randomBytes(byteSize, (err, salt) => {\n      if (err) {\n        callback(err);\n      } else {\n        callback(null, salt.toString('base64'));\n      }\n    });\n  },\n\n  /**\n   * Encrypt password\n   *\n   * @param {String} password\n   * @param {Function} callback\n   * @return {String}\n   * @api public\n   */\n  encryptPassword(password, callback) {\n    if (!password || !this.salt) {\n      return null;\n    }\n\n    var defaultIterations = 10000;\n    var defaultKeyLength = 64;\n    var salt = new Buffer(this.salt, 'base64');\n\n    if (!callback) {\n      return crypto.pbkdf2Sync(password, salt, defaultIterations, defaultKeyLength)\n                   .toString('base64');\n    }\n\n    return crypto.pbkdf2(password, salt, defaultIterations, defaultKeyLength, (err, key) => {\n      if (err) {\n        callback(err);\n      } else {\n        callback(null, key.toString('base64'));\n      }\n    });\n  }\n};\n\nexport default mongoose.model('User', UserSchema);\n"]}